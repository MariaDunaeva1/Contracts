FROM golang:1.23-alpine

WORKDIR /app

# Instalar dependencias del sistema y Python/Kaggle CLI
RUN apk add --no-cache git python3 py3-pip && \
    pip install kaggle --break-system-packages

# Crear directorio para configuración de Kaggle
RUN mkdir -p /root/.kaggle

# Copiar archivos de dependencias
COPY go.mod go.sum ./

# Descargar dependencias
RUN go mod download

# Copiar todo el código
COPY . .

# Compilar el servidor
RUN go build -o /usr/local/bin/server cmd/server/main.go

# Script para crear kaggle.json desde variables de entorno
RUN echo '#!/bin/sh' > /entrypoint.sh && \
    echo 'echo "{\"username\":\"$KAGGLE_USERNAME\",\"key\":\"$KAGGLE_KEY\"}" > /root/.kaggle/kaggle.json' >> /entrypoint.sh && \
    echo 'chmod 600 /root/.kaggle/kaggle.json' >> /entrypoint.sh && \
    echo 'exec /usr/local/bin/server' >> /entrypoint.sh && \
    chmod +x /entrypoint.sh

CMD ["/entrypoint.sh"]