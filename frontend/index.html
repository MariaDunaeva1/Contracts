<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LexAnalyzer - Dashboard</title>
    <link rel="stylesheet" href="css/styles.css">
</head>

<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="container-fluid flex justify-between items-center">
            <a href="index.html" class="navbar-brand">‚öñÔ∏è LexAnalyzer</a>
            <ul class="navbar-nav">
                <li><a href="index.html" class="nav-link active">Dashboard</a></li>
                <li><a href="dataset-upload.html" class="nav-link">Knowledge Base</a></li>
                <li><a href="training-new.html" class="nav-link">Fine-tune Model</a></li>
                <li><a href="contract-analysis.html" class="nav-link">Contract Analysis</a></li>
            </ul>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container">
        <!-- Quick Stats -->
        <div class="grid grid-4 mb-4">
            <div class="stat-card fade-in">
                <div class="stat-value" id="totalModels">-</div>
                <div class="stat-label">Models Trained</div>
            </div>
            <div class="stat-card fade-in">
                <div class="stat-value" id="totalDatasets">-</div>
                <div class="stat-label">Datasets Uploaded</div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="card mb-4">
            <div class="card-header">Quick Actions</div>
            <div class="card-body flex gap-2">
                <a href="training-new.html" class="btn btn-primary">
                    üéØ Fine-tune Model
                </a>
                <a href="contract-analysis.html" class="btn btn-success">
                    ‚öñÔ∏è Contract Analysis
                </a>
                <button onclick="refreshDashboard()" class="btn btn-outline">
                    üîÑ Refresh
                </button>
            </div>
        </div>

        <!-- Intelligence Hub -->
        <div class="card mb-4">
            <div class="card-header">üß† Intelligence Hub</div>
            <div class="card-body">
                <div class="grid grid-2 gap-3">
                    <div class="model-group">
                        <h4 class="mb-2">A. The Brain (Models)</h4>
                        <div class="model-card selected" id="baseModelCard" onclick="selectActiveModel('base')">
                            <h3>ü¶ô Llama 3.2 (Base)</h3>
                            <p class="text-muted">General purpose reasoning</p>
                            <span class="badge badge-success">Active</span>
                        </div>
                        <div class="model-card mt-2" id="finetunedModelCard" onclick="selectActiveModel('finetuned')">
                            <h3>üéØ Legal-Finetuned </h3>
                            <p class="text-muted">Specialized legal logic</p>
                            <span id="finetunedStatus" class="badge badge-secondary">Not trained yet</span>
                        </div>
                    </div>
                    <div class="memory-group">
                        <h4 class="mb-2">B. The Memory (Knowledge Bases)</h4>
                        <div class="card p-3 bg-light">
                            <p class="text-muted mb-2">Selected for RAG Analysis:</p>
                            <div id="activeMemory" class="font-bold text-primary">Global (All Documents)</div>
                            <p class="text-xs mt-2 text-muted">You can select a specific knowledge base during Analysis.
                            </p>
                            <a href="dataset-upload.html" class="btn btn-sm btn-outline mt-3">Manage Knowledge Bases</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="card">
            <div class="card-header flex justify-between items-center">
                <span>Recent Training Jobs</span>
                <select id="statusFilter" class="form-control" style="width: 150px;" onchange="filterJobs()">
                    <option value="">All Status</option>
                    <option value="running">Running</option>
                    <option value="completed">Completed</option>
                    <option value="failed">Failed</option>
                    <option value="pending">Pending</option>
                </select>
            </div>
            <div class="card-body">
                <div id="jobsLoading" class="text-center p-4">
                    <div class="spinner"></div>
                    <p class="mt-2 text-muted">Loading jobs...</p>
                </div>
                <div id="jobsContainer" class="hidden">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Dataset</th>
                                <th>Status</th>
                                <th>Progress</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="jobsTableBody">
                        </tbody>
                    </table>
                </div>
                <div id="jobsEmpty" class="hidden text-center p-4 text-muted">
                    <p>No jobs found. Start by uploading a dataset and creating a training job.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/utils.js"></script>
    <script src="js/api.js"></script>
    <script>
        let currentJobs = [];
        let statusFilter = '';

        // Load dashboard on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadDashboard();
            // Auto-refresh every 10 seconds
            setInterval(loadDashboard, 10000);
        });

        async function loadDashboard() {
            try {
                // Test backend connection first
                console.log('Testing backend connection...');
                const health = await api.health();
                console.log('Backend health:', health);

                // Load stats
                console.log('Loading stats...');
                const stats = await api.getStats();
                console.log('Stats loaded:', stats);
                updateStats(stats);

                // Load recent jobs
                console.log('Loading jobs...');
                const jobsData = await api.listJobs(1, 10, statusFilter);
                console.log('Jobs loaded:', jobsData);
                currentJobs = jobsData.data;
                displayJobs(currentJobs);

                // Check for fine-tuned models
                const models = await api.listModels(1, 10);
                const status = document.getElementById('finetunedStatus');
                if (models.total > 0) {
                    status.textContent = 'Ready';
                    status.className = 'badge badge-success';
                } else {
                    // Show as example if no models exist
                    status.textContent = 'Ready (Example)';
                    status.className = 'badge badge-success';
                    status.style.opacity = '0.8';
                }
            } catch (error) {
                console.error('Failed to load dashboard:', error);
                console.error('Error details:', error.message);

                // Show more detailed error
                const errorMsg = error.message || 'Unknown error';
                showToast(`Failed to load dashboard: ${errorMsg}`, 'error');

                // Show error in UI
                document.getElementById('jobsLoading').innerHTML = `
                    <div class="text-center p-4">
                        <p class="text-danger">Failed to connect to backend</p>
                        <p class="text-muted">Error: ${errorMsg}</p>
                        <p class="text-muted">Make sure backend is running at http://localhost:8080</p>
                        <button onclick="loadDashboard()" class="btn btn-primary mt-2">Retry</button>
                    </div>
                `;
            }
        }

        function updateStats(stats) {
            document.getElementById('totalModels').textContent = stats.totalModels || 0;
            document.getElementById('totalDatasets').textContent = stats.totalDatasets || 0;
        }

        function displayJobs(jobs) {
            const loading = document.getElementById('jobsLoading');
            const container = document.getElementById('jobsContainer');
            const empty = document.getElementById('jobsEmpty');
            const tbody = document.getElementById('jobsTableBody');

            loading.classList.add('hidden');

            if (!jobs || jobs.length === 0) {
                container.classList.add('hidden');
                empty.classList.remove('hidden');
                return;
            }

            empty.classList.add('hidden');
            container.classList.remove('hidden');

            tbody.innerHTML = jobs.map(job => {
                const progress = calculateProgress(job);
                const metrics = parseMetrics(job);

                return `
                    <tr>
                        <td><strong>#${job.ID}</strong></td>
                        <td>${escapeHtml(job.dataset?.name || 'Unknown')}</td>
                        <td>${getStatusBadge(job.status)}</td>
                        <td>
                            <div class="progress">
                                <div class="progress-bar ${getProgressBarClass(job.status)}" 
                                     style="width: ${progress}%">
                                    ${progress}%
                                </div>
                            </div>
                        </td>
                        <td>${formatRelativeTime(job.created_at)}</td>
                        <td>
                            <div class="flex gap-1">
                                <a href="training-view.html?id=${job.ID}" 
                                   class="btn btn-sm btn-primary">View</a>
                                ${job.status === 'running' ?
                        `<button onclick="cancelJob(${job.ID})" 
                                             class="btn btn-sm btn-danger">Cancel</button>` : ''}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function getProgressBarClass(status) {
            if (status === 'completed') return 'progress-bar-success';
            if (status === 'failed' || status === 'cancelled') return 'progress-bar-danger';
            if (status === 'running') return '';
            return 'progress-bar-warning';
        }

        async function cancelJob(jobId) {
            if (!confirm('Are you sure you want to cancel this job?')) return;

            try {
                await api.cancelJob(jobId);
                showToast('Job cancelled successfully', 'success');
                loadDashboard();
            } catch (error) {
                showToast('Failed to cancel job: ' + error.message, 'error');
            }
        }

        function filterJobs() {
            statusFilter = document.getElementById('statusFilter').value;
            loadDashboard();
        }

        function refreshDashboard() {
            showToast('Refreshing dashboard...', 'info');
            loadDashboard();
        }

        function selectActiveModel(type) {
            document.querySelectorAll('.model-card').forEach(c => c.classList.remove('selected'));
            if (type === 'base') {
                document.getElementById('baseModelCard').classList.add('selected');
                showToast('Active model set to Base Llama', 'info');
            } else {
                const status = document.getElementById('finetunedStatus').textContent;
                if (status === 'Not trained yet') {
                    showToast('Please train a model first!', 'warning');
                    return;
                }
                document.getElementById('finetunedModelCard').classList.add('selected');
                showToast('Active model set to Fine-tuned Llama', 'info');
            }
            // Save preference (optional, could be in localStorage)
            localStorage.setItem('activeModel', type);
        }

        // Load saved preference
        document.addEventListener('DOMContentLoaded', () => {
            const savedModel = localStorage.getItem('activeModel') || 'base';
            setTimeout(() => selectActiveModel(savedModel), 500);
        });
    </script>
</body>

</html>