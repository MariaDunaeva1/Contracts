<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Model Evaluation Viewer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
        }

        .controls {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        input, select {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        button {
            padding: 10px 20px;
            background: #0066cc;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }

        button:hover {
            background: #0052a3;
        }

        .comparison-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .metrics-card {
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .metrics-card.highlight {
            border: 2px solid #4caf50;
        }

        .metrics-card h3 {
            margin-bottom: 20px;
            color: #333;
            font-size: 18px;
        }

        .metric {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #eee;
        }

        .metric:last-child {
            border-bottom: none;
        }

        .metric-label {
            color: #666;
            font-weight: 500;
        }

        .metric-value {
            font-weight: bold;
            font-size: 18px;
        }

        .metric-value.success {
            color: #4caf50;
        }

        .metric-value.warning {
            color: #ff9800;
        }

        .improvement {
            font-size: 14px;
            margin-left: 8px;
            color: #4caf50;
        }

        .examples-section {
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .examples-section h3 {
            margin-bottom: 20px;
            color: #333;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: #f5f5f5;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #333;
            border-bottom: 2px solid #ddd;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #eee;
        }

        tr:hover {
            background: #f9f9f9;
        }

        .correct {
            color: #4caf50;
        }

        .wrong {
            color: #f44336;
        }

        .winner-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }

        .winner-badge.fine-tuned {
            background: #4caf50;
            color: white;
        }

        .winner-badge.base {
            background: #ff9800;
            color: white;
        }

        .winner-badge.tie {
            background: #9e9e9e;
            color: white;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        .empty-state {
            text-align: center;
            padding: 60px;
            color: #999;
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-box {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #0066cc;
        }

        .stat-label {
            color: #666;
            margin-top: 8px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéØ Model Evaluation Comparison</h1>
        <p class="subtitle">Compare base model vs fine-tuned model performance</p>

        <div class="controls">
            <label>Evaluation ID:</label>
            <input type="number" id="evalId" value="1" min="1">
            <button onclick="loadEvaluation()">Load Evaluation</button>
            <span style="margin-left: auto;">
                <label>Model ID:</label>
                <input type="number" id="modelId" value="1" min="1">
                <button onclick="createEvaluation()">Create New Evaluation</button>
            </span>
        </div>

        <div id="content">
            <div class="empty-state">
                Enter an Evaluation ID and click "Load Evaluation" to view results
            </div>
        </div>
    </div>

    <script>
        async function loadEvaluation() {
            const evalId = document.getElementById('evalId').value;
            if (!evalId) {
                alert('Please enter an Evaluation ID');
                return;
            }

            const content = document.getElementById('content');
            content.innerHTML = '<div class="loading">Loading evaluation...</div>';

            try {
                const response = await fetch(`http://localhost:8080/api/v1/evaluations/${evalId}`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                displayEvaluation(data);
            } catch (error) {
                content.innerHTML = `<div class="error">Error loading evaluation: ${error.message}</div>`;
            }
        }

        async function createEvaluation() {
            const modelId = document.getElementById('modelId').value;
            if (!modelId) {
                alert('Please enter a Model ID');
                return;
            }

            try {
                const response = await fetch(`http://localhost:8080/api/v1/models/${modelId}/evaluate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        test_set_path: 'datasets/test_split.json',
                        base_model_name: 'llama3.2:3b'
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                alert(`Evaluation created! ID: ${data.evaluation_id}\nStatus: ${data.status}`);
                
                // Load the new evaluation
                document.getElementById('evalId').value = data.evaluation_id;
                setTimeout(() => loadEvaluation(), 1000);
            } catch (error) {
                alert(`Error creating evaluation: ${error.message}`);
            }
        }

        function displayEvaluation(data) {
            const content = document.getElementById('content');
            
            if (data.status === 'pending' || data.status === 'running') {
                content.innerHTML = `
                    <div class="loading">
                        Evaluation is ${data.status}... Please wait and refresh.
                    </div>
                `;
                return;
            }

            if (data.status === 'failed') {
                content.innerHTML = `
                    <div class="error">
                        Evaluation failed: ${data.error_message || 'Unknown error'}
                    </div>
                `;
                return;
            }

            const results = data.results || {};
            const baseModel = results.base_model || {};
            const fineTuned = results.fine_tuned || {};
            const improvement = results.improvement || {};
            const examples = data.examples || [];

            content.innerHTML = `
                <div class="summary-stats">
                    <div class="stat-box">
                        <div class="stat-value">${data.status}</div>
                        <div class="stat-label">Status</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value">${examples.length}</div>
                        <div class="stat-label">Test Examples</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value">${data.base_model_name || 'N/A'}</div>
                        <div class="stat-label">Base Model</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value">${data.fine_tuned_name || 'N/A'}</div>
                        <div class="stat-label">Fine-tuned Model</div>
                    </div>
                </div>

                <div class="comparison-grid">
                    <div class="metrics-card">
                        <h3>üìä Base Model</h3>
                        ${renderMetrics(baseModel)}
                    </div>
                    <div class="metrics-card highlight">
                        <h3>üöÄ Fine-tuned Model</h3>
                        ${renderMetrics(fineTuned, improvement)}
                    </div>
                </div>

                <div class="examples-section">
                    <h3>üìù Example Comparisons</h3>
                    ${renderExamples(examples)}
                </div>
            `;
        }

        function renderMetrics(metrics, improvement = {}) {
            const accuracy = (metrics.accuracy * 100).toFixed(1);
            const f1 = (metrics.f1_score || 0).toFixed(3);
            const precision = (metrics.precision || 0).toFixed(3);
            const recall = (metrics.recall || 0).toFixed(3);
            const responseTime = (metrics.avg_response_time_ms || 0).toFixed(0);

            return `
                <div class="metric">
                    <span class="metric-label">Accuracy</span>
                    <span class="metric-value ${improvement.accuracy_delta ? 'success' : ''}">
                        ${accuracy}%
                        ${improvement.accuracy_delta ? `<span class="improvement">${improvement.accuracy_delta}</span>` : ''}
                    </span>
                </div>
                <div class="metric">
                    <span class="metric-label">F1 Score</span>
                    <span class="metric-value ${improvement.f1_score_delta ? 'success' : ''}">
                        ${f1}
                        ${improvement.f1_score_delta ? `<span class="improvement">${improvement.f1_score_delta}</span>` : ''}
                    </span>
                </div>
                <div class="metric">
                    <span class="metric-label">Precision</span>
                    <span class="metric-value">
                        ${precision}
                        ${improvement.precision_delta ? `<span class="improvement">${improvement.precision_delta}</span>` : ''}
                    </span>
                </div>
                <div class="metric">
                    <span class="metric-label">Recall</span>
                    <span class="metric-value">
                        ${recall}
                        ${improvement.recall_delta ? `<span class="improvement">${improvement.recall_delta}</span>` : ''}
                    </span>
                </div>
                <div class="metric">
                    <span class="metric-label">Avg Response Time</span>
                    <span class="metric-value">${responseTime}ms</span>
                </div>
            `;
        }

        function renderExamples(examples) {
            if (!examples || examples.length === 0) {
                return '<p style="color: #999;">No examples available</p>';
            }

            const rows = examples.map(ex => `
                <tr>
                    <td>${escapeHtml(ex.input || '')}</td>
                    <td>${escapeHtml(ex.expected || '')}</td>
                    <td class="${ex.base_model_correct ? 'correct' : 'wrong'}">
                        ${escapeHtml(ex.base_model_output || '')} ${ex.base_model_correct ? '‚úÖ' : '‚ùå'}
                    </td>
                    <td class="${ex.fine_tuned_correct ? 'correct' : 'wrong'}">
                        ${escapeHtml(ex.fine_tuned_output || '')} ${ex.fine_tuned_correct ? '‚úÖ' : '‚ùå'}
                    </td>
                    <td>
                        <span class="winner-badge ${ex.winner || 'tie'}">${ex.winner || 'tie'}</span>
                    </td>
                </tr>
            `).join('');

            return `
                <table>
                    <thead>
                        <tr>
                            <th>Input</th>
                            <th>Expected</th>
                            <th>Base Model</th>
                            <th>Fine-tuned</th>
                            <th>Winner</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${rows}
                    </tbody>
                </table>
            `;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
